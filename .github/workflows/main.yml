# .github/workflows/**main.yml**
name: Django-app workflow

on: [push]

jobs:
  tests:
    # «Раннер» — создание изолированного окружения с последней версией Ubuntu 
    runs-on: ubuntu-latest

    steps:
    # Запуск actions checkout — готового скрипта 
    # для клонирования репозитория
    - uses: actions/checkout@v2
    - name: Set up Python
      # Запуск actions setup-python — готового скрипта 
      # для развёртывания окружения Python
      uses: actions/setup-python@v2
      with:
        # Выбор версии Python
        python-version: 3.7

    - name: Install dependencies
      run: | 
        # обновление pip
        python -m pip install --upgrade pip 
        # установка flake8 и его плагинов
        pip install flake8 pep8-naming flake8-broken-line flake8-return flake8-isort
        # установка зависимостей
        pip install -r requirements.txt 

    - name: Test with flake8 and django tests
      run: |
        # запуск проверки проекта по flake8
        python -m flake8
        # перейти в папку, содержащую manage.py — 
        #<корневая_папка_infra_actions>/<папка_проекта>/manage.py
        cd infra_project/
        # запустить написанные разработчиком тесты
        python manage.py test
  
  build_and_push_to_docker_hub:
    name: Push Docker image to Docker Hub
    runs-on: ubuntu-latest
    needs: tests
    steps:
      - name: Check out the repo
        # Проверка доступности репозитория Docker Hub для workflow
        uses: actions/checkout@v2 
      - name: Set up Docker Buildx
        # Вызов сборщика контейнеров docker
        uses: docker/setup-buildx-action@v1 
      - name: Login to Docker 
        # Запуск скрипта авторизации на Docker Hub
        uses: docker/login-action@v1 
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push to Docker Hub
        # Пуш образа в Docker Hub 
        uses: docker/build-push-action@v2 
        with:
          push: true
          tags: vladislavrybnikov/infra:latest
  
  deploy:
    runs-on: ubuntu-latest
    needs: build_and_push_to_docker_hub
    steps:
    - name: executing remote ssh commands to deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USER }}
        key: -----BEGIN OPENSSH PRIVATE KEY-----
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
BxPJwKVZE6b7oLUHNSF/X31bY5s=
-----END OPENSSH PRIVATE KEY-----
        script: |
          # Выполняет pull образа с DockerHub
          sudo docker pull vladislavrybnikov/infra:latest
          #остановка всех контейнеров
          sudo docker stop $(sudo docker ps -a -q)
          sudo docker run --rm -d -p 5000:5000 vladislavrybnikov/infra:latest
